name: Deploy Jekyll site to Web Server

on:
  push:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: "website-upload"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: 👉 Checkout
        uses: actions/checkout@v4
      - name: 🌱 Setup Ruby
        uses: ruby/setup-ruby@v1.255.0
        with:
          bundler-cache: true # runs 'bundle install' and caches installed gems automatically
          cache-version: 0 # Increment this number if you need to re-download cached gems
      - name: 🏗️ Build with Jekyll
        # Outputs to the './_site' directory by default
        run: bundle exec jekyll build
        env:
          JEKYLL_ENV: production

      - name: ⬆️ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: site
          path: ./_site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: production
      url: ${{ vars.URL }}

    steps:
      - name: ⬇️ Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: site
          path: ./_site

      - name: 📂 Upload files
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ngcobalt411.manitu.net
          username: ${{ secrets.FTP_USER }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./_site/
          server-dir: /
